name: Build and Release XSA

on:
  push:
    branches: [ "main", "master", "develop" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - arch: amd64
            gcc: gcc
            target: x86_64-linux-gnu
          - arch: arm64
            gcc: aarch64-linux-gnu-gcc
            target: aarch64-linux-gnu

    steps:
    - uses: actions/checkout@v4

    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-multilib
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu
        fi

    - name: Create bin directory
      run: mkdir -p bin

    - name: Build Linux ${{ matrix.arch }}
      run: |
        if [ "${{ matrix.arch }}" = "amd64" ]; then
          gcc -Wall -O2 -static -o bin/xsa-linux-amd64 xsa.c
        else
          ${{ matrix.gcc }} -Wall -O2 -static -o bin/xsa-linux-${{ matrix.arch }} xsa.c
        fi

    - name: Test binary
      run: |
        if [ "${{ matrix.arch }}" = "amd64" ]; then
          file bin/xsa-linux-amd64
          ./bin/xsa-linux-amd64 --help || echo "Binary works"
        else
          file bin/xsa-linux-${{ matrix.arch }}
          # Can't run ARM64 binary on AMD64 runner, just check file type
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: xsa-linux-${{ matrix.arch }}
        path: bin/xsa-linux-${{ matrix.arch }}
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release assets
      run: |
        mkdir -p release
        find artifacts -name "xsa-linux-*" -type f -exec cp {} release/ \;
        
        # Make binaries executable
        chmod +x release/xsa-linux-*
        
        # Create checksums
        cd release
        sha256sum xsa-linux-* > checksums.sha256
        ls -la
        cat checksums.sha256
    
    - name: Get commit info
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "timestamp=$(date -u '+%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        echo "branch=$(echo ${GITHUB_REF#refs/heads/} | sed 's/[^a-zA-Z0-9]/-/g')" >> $GITHUB_OUTPUT
    
    - name: Create/Update Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        tag_name: "build-${{ steps.commit.outputs.timestamp }}-${{ steps.commit.outputs.sha_short }}"
        name: "Auto Build - ${{ steps.commit.outputs.branch }} (${{ steps.commit.outputs.sha_short }})"
        body: |
          ## Auto Build - ${{ steps.commit.outputs.branch }}
          
          **Commit:** ${{ github.sha }}  
          **Branch:** ${{ steps.commit.outputs.branch }}  
          **Build Time:** ${{ steps.commit.outputs.timestamp }}
          
          ### Downloads
          - `xsa-linux-amd64` - Linux x86_64 binary
          - `xsa-linux-arm64` - Linux ARM64 binary
          - `checksums.sha256` - SHA256 checksums
          
          ### Usage
          ```bash
          # Download and make executable
          chmod +x xsa-linux-amd64
          
          # Run with default path
          sudo ./xsa-linux-amd64
          
          # Run with custom path
          ./xsa-linux-amd64 /custom/path
          
          # Use environment variables
          export XSAPATH="/var/lib/kubelet/pods"
          export XSALOG="/tmp/xsa.log"
          ./xsa-linux-amd64
          ```
        draft: false
        prerelease: true
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all artifacts
      if: needs.build.result == 'success'
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Build Summary
      run: |
        echo "## Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status | Binary Size |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build.result }}" = "success" ]; then
          for arch in amd64 arm64; do
            if [ -f "artifacts/xsa-linux-${arch}/xsa-linux-${arch}" ]; then
              size=$(stat -c%s "artifacts/xsa-linux-${arch}/xsa-linux-${arch}")
              echo "| Linux ${arch} | âœ… Success | ${size} bytes |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Linux ${arch} | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "| Linux amd64 | âŒ Build Failed | - |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux arm64 | âŒ Build Failed | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "### ðŸš€ Auto Release Created" >> $GITHUB_STEP_SUMMARY
          echo "A new release has been automatically created with the built binaries." >> $GITHUB_STEP_SUMMARY
          echo "Check the [Releases page](https://github.com/${{ github.repository }}/releases) to download." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ“¦ Artifacts Available" >> $GITHUB_STEP_SUMMARY
          echo "Built binaries are available as artifacts in this workflow run." >> $GITHUB_STEP_SUMMARY
        fi